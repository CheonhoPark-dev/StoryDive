{% extends "layout.html" %}

{% block title %}세계관 수정 - {{ world.title if world else '알 수 없음' }} - 스토리 다이브{% endblock %}

{% block page_header %}{{ world.title if world else '세계관' }} 정보 수정{% endblock %}

{% block content %}
<div id="edit-world-form-container" class="content-card p-8 rounded-xl shadow-lg mb-8 md:col-span-2 lg:col-span-3 card-hover">
    {% if world %}
    <h3 class="text-2xl font-semibold mb-6 text-header text-center gradient-text">세계관 정보 수정: {{ world.title }}</h3>
    <form id="edit-world-form" class="space-y-6" data-world-id="{{ world.id }}">
        <div>
            <label for="edit-world-title" class="block text-sm font-medium text-subheader mb-1">세계관 제목 <span class="text-red-500">*</span></label>
            <input type="text" id="edit-world-title" name="title" required value="{{ world.title or '' }}"
                   class="w-full p-3 input-field rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">
        </div>
        <div>
            <label for="edit-world-setting" class="block text-sm font-medium text-subheader mb-1">세계관 상세 설정 <span class="text-red-500">*</span></label>
            <textarea id="edit-world-setting" name="setting" rows="6" required
                      class="w-full p-3 input-field rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">{{ world.setting or '' }}</textarea>
        </div>
        <div class="flex items-center">
            <input type="checkbox" id="edit-world-is-public" name="is_public" {% if world.is_public %}checked{% endif %}
                   class="h-5 w-5 text-indigo-600 border-gray-600 rounded focus:ring-indigo-500 mr-2 bg-gray-700">
            <label for="edit-world-is-public" class="text-sm font-medium text-subheader">다른 사용자에게 공개하기</label>
        </div>
        <div>
            <label for="edit-world-genre" class="block text-sm font-medium text-subheader mb-1">장르</label>
            <input type="text" id="edit-world-genre" name="genre" value="{{ world.genre or '' }}"
                   class="w-full p-3 input-field rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
                   placeholder="예: 판타지, SF, 미스터리 (선택 사항)">
        </div>
        <div>
            <label for="edit-world-tags" class="block text-sm font-medium text-subheader mb-1">태그 (쉼표로 구분)</label>
            <input type="text" id="edit-world-tags" name="tags" value="{{ world.tags|join(', ') if world.tags else '' }}"
                   class="w-full p-3 input-field rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
                   placeholder="예: 마법, 학원물, 동물, 비밀 (선택 사항)">
        </div>
        <div>
            <label for="edit-world-cover-image-url" class="block text-sm font-medium text-subheader mb-1">커버 이미지 URL</label>
            <input type="url" id="edit-world-cover-image-url" name="cover_image_url" value="{{ world.cover_image_url or '' }}"
                   class="w-full p-3 input-field rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
                   placeholder="세계관을 나타내는 이미지 주소 (선택 사항)">
        </div>

        <!-- 게임 시스템 설정 섹션 (수정 폼) -->
        <div class="mb-6 p-4 border border-gray-700 rounded-lg">
            <h4 class="text-lg font-medium text-subheader mb-3">게임 시스템 설정 (선택 사항)</h4>
            <div id="edit-world-systems-container" class="space-y-4">
                <p class="text-sm text-gray-500 {% if world.systems and world.systems|length > 0 %}hidden{% endif %}">아직 추가된 시스템이 없습니다. "시스템 추가" 버튼을 눌러 캐릭터 스탯, 재화, 포인트 등을 설정하세요.</p>
            </div>
            <button type="button" id="edit-add-world-system-btn"
                    class="mt-4 btn-secondary text-white px-4 py-2 rounded-md text-sm font-medium transition hover:bg-teal-600 btn-glow">
                <i class="fas fa-plus mr-1"></i> 시스템 추가
            </button>
        </div>

        <div>
            <label for="edit-world-starting-point" class="block text-sm font-medium text-subheader mb-1">이야기 시작점 (선택 사항)</label>
            <textarea id="edit-world-starting-point" name="starting_point" rows="4"
                      class="w-full p-3 input-field rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">{{ world.starting_point or '' }}</textarea>
        </div>
        <div class="flex justify-end space-x-3">
            <button type="button" id="cancel-edit-world-btn" class="btn-gray text-white px-6 py-3 rounded-lg font-medium transition">
                취소 (내 세계관 목록으로)
            </button>
            <button type="submit" id="submit-edit-world-btn" class="btn-primary text-white px-6 py-3 rounded-lg font-medium transition flex items-center justify-center btn-glow">
                <i class="fas fa-save mr-2"></i>변경사항 저장하기
            </button>
        </div>
    </form>
    <div id="edit-world-feedback" class="mt-4 text-sm text-content"></div>
    {% else %}
    <p class="text-red-500 text-center">수정할 세계관 정보를 불러오지 못했습니다. ID가 올바른지 확인해주세요.</p>
    <div class="text-center mt-4">
        <a href="{{ url_for('my_worlds_page') }}" class="btn-primary text-white px-6 py-3 rounded-lg font-medium transition">내 세계관 목록으로 돌아가기</a>
    </div>
    {% endif %}
</div>

{# world 데이터를 JSON으로 스크립트 태그에 삽입 #}
<script id="world-data-script" type="application/json">
    {{ world | tojson | safe if world else 'null' }}
</script>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // 이 스크립트 블록의 내용은 main.js로 대부분 옮겨졌습니다.
        // 취소 버튼의 리디렉션만 남겨두거나, 이마저도 main.js에서 경로 기반으로 처리할 수 있습니다.
        const cancelBtn = document.getElementById('cancel-edit-world-btn');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                window.location.href = "{{ url_for('my_worlds_page') }}";
            });
        }
    });
</script>
{% endblock %} 